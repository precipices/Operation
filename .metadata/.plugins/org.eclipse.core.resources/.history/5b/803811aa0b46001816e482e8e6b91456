package temp;

import java.util.Vector;

import javax.swing.ImageIcon;
import javax.swing.JFrame;
import javax.swing.JOptionPane;

import com.operation.client.MainFrame;
import com.operation.common.Message;
import com.operation.common.Operation;
import com.operation.common.Worker;
import com.operation.rpc.RPCHelper;

public class TestGetMessage {
	public static void main(String[] args) {
		RPCHelper helper = null;
		Worker worker = null;
		JFrame myFrame = null;

		helper = new RPCHelper();
		helper.login("w0001", "123");
		worker = helper.selectWorkerById("w0001");
		myFrame = new MainFrame(helper, worker);
		Vector<Message> messages = helper.getMessage();
		if (messages.size() == 0) {
			System.out.println("没有信息");
		}
		String mes = null;
		ImageIcon imageIcon = new ImageIcon("./imgs/1.jpg");
		Object[] options = { "授受", "拒绝" };
		for (Message m : messages) {
			int type = m.getMessageType();
			// 得到信息
			Operation op = helper.selectOperationById(m.getOperationId());
			String operationName = op.getName();
			Worker fromWorker = helper.selectWorkerById(m.getFromId());
			int choose=0;
			switch (type) {
			case Message.CHOOSE://你被邀请参与该手术
				mes = "医生[" + fromWorker.getName() + "]邀请你参与["+op.getBeginTime()+"]的手术[" + operationName + "]!";
				// 打开消息窗口
				choose = JOptionPane.showOptionDialog(myFrame, mes, "手术邀请", JOptionPane.DEFAULT_OPTION,
						JOptionPane.INFORMATION_MESSAGE, imageIcon, options, options[0]);
				if(choose==0) {//授受
					helper.sendMessage(m.getFromId(), m.getOperationId(), Message.ACCEPT);
				}else if(choose==1) {//拒绝
					helper.sendMessage(m.getFromId(), m.getOperationId(), Message.REFUSE);
					if(fromWorker.getPosition().equals("护士"))
						helper.updateNurseToOperation(m.getOperationId(), null);
					else if(fromWorker.getPosition().equals("麻醉师")) {
						helper.updateAnesthetistToOperation(m.getOperationId(), null);
					}
				}
				break;
			case Message.ACCEPT://对方接受了你的邀请
				mes = fromWorker.getPosition() + "[" + fromWorker.getName() + "]授受了你的[" + operationName + "]手术邀请!";
				// 打开消息窗口
				JOptionPane.showMessageDialog(myFrame, mes,"对方接受了邀请",  JOptionPane.INFORMATION_MESSAGE,imageIcon);
				break;
			case Message.REFUSE://对方拒绝了你的邀请
				mes = fromWorker.getPosition() + "[" + fromWorker.getName() + "拒绝了你的[" + operationName + "]手术邀请,系统将自动分配参与者!";
				// 打开消息窗口
				JOptionPane.showMessageDialog(myFrame, mes,"对方拒绝了邀请",  JOptionPane.INFORMATION_MESSAGE,imageIcon);
				//自动分配员工
				Worker selectWorker=null;
				if(fromWorker.getPosition().equals("护士")) {
					selectWorker = helper.autoSelectNurse(op.getBeginTime(), m.getFromId());
					helper.sendMessage(selectWorker.getId(), op.getId(), Message.AUTOCHOOSE);
				}
				else if(fromWorker.getPosition().equals("麻醉师")) {
					helper.autoSelectAnesthetist(op.getBeginTime(), m.getFromId());
					helper.sendMessage(selectWorker.getId(), op.getId(), Message.AUTOCHOOSE);
				}
				break;
			case Message.NOTCHOOSE://你被从该手术中剔除
				mes = "["+op.getBeginTime()+"]的手术[" + operationName + "]的发起者更换了参与者,请注意!";
				// 打开消息窗口
				JOptionPane.showMessageDialog(myFrame, mes,"手术参与者更换",  JOptionPane.INFORMATION_MESSAGE,imageIcon);
				break;
			case Message.AUTOCHOOSE://该手术参与者拒绝了参与邀请,你被自动选择为选择为替代者,不可拒绝
				mes = "["+op.getBeginTime()+"]的手术[" + operationName + "]选择的参与者拒绝了参与邀请,你被自动选择为选择为替代者,不可拒绝!";
				// 打开消息窗口
				JOptionPane.showMessageDialog(myFrame, mes,"手术邀请",  JOptionPane.INFORMATION_MESSAGE,imageIcon);
				break;
			}
			// 处理完后移除该消息
			helper.removeMessage(m);
		}
		
		
		
		
		
		
		
	}
}
